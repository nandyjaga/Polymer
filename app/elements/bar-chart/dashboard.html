<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<dom-module id="dashboard-page">
  <template>
   <div class="horizontal-section-container">
      <div>
        <div class="horizontal-section">
		  <paper-dropdown-menu label="Select Partner Type" on-iron-select="handleSelectionChange" >
			  <paper-menu class="dropdown-content" selected="{{selectedPartner}}" >
				<template    is="dom-repeat" items="[[partnerType]]" as="partner">
					<paper-item>[[partner]]</paper-item>
				</template>
			  </paper-menu>
			</paper-dropdown-menu>
			
			<paper-dropdown-menu label="Select Year" on-iron-select="handleSelectionChange"  >
			  <paper-menu class="dropdown-content" selected="{{selectedYear}}" >
				<template    is="dom-repeat" items="[[yearsList]]" as="year">
					<paper-item>[[year]]</paper-item>
				</template>
			  </paper-menu>
			</paper-dropdown-menu>
			
			<paper-dropdown-menu label="Select Quarter" on-iron-select="CreateChart" >
			  <paper-menu class="dropdown-content" selected="{{selectedQuarter}}" >
				<template    is="dom-repeat" items="[[quaterList]]" as="quater">
					<paper-item>[[quater]]</paper-item>
				</template>
			  </paper-menu>
			</paper-dropdown-menu>
        </div>
      </div>
    </div>
	
	
	<div hidden$="{{showChart}}" >
	
		<google-chart
		  type='pie'
		  options='{"title": "Deals count for the selected quarter"}'
		  cols='{{chartCols}}'
		  rows='{{chartrows}}'>
		</google-chart>
	
		  <google-chart
		  type='bar'
		  options='{"title": "Deals count for the selected quarter"}'
		  cols='{{chartCols}}'
		  rows='{{chartrows}}'>
		</google-chart>
	
	
	</div>
	

    <iron-ajax 
           auto
           id="ajax" url="../../service/LiveData.json" method="get"
           handle-as="json"
           on-response="dataLoaded"
           on-error="errorHandler"
            ></iron-ajax>
            
	
            
            
    
           
  </template>

  <script>
    (function() {
      'use strict';
      
      Polymer({
        is: 'dashboard-page',

        properties: {
		   quaterMap:{
		      type: Object,
              notify: true
		   },
		   showChart:{
		      type: Boolean,
              notify: true,
			  value:true
		   },
           yearsList: {
            type: Array,
            notify: true
          },
           quaterList: {
            type: Array,
            notify: true
          },
          partnerType: {
            type: Array,
            notify: true
          },
		  chartCols: {
            type: Array,
            notify: true,
			value:[ {"label":"Deals Type", "type":"string"}, {"label":"Deals Count", "type":"number"} ]
          },
		  chartrows: {
            type: Array,
            notify: true,
			value:[]
          },
		  chartData: {
            type: Array,
            notify: true
          },
		  selectedYear: {
            type: String,
            notify: true
          },
		  selectedPartner: {
            type: String,
            notify: true
          },
		  selectedQuarter: {
            type: String,
            notify: true
          },
		  masterAjaxData:{
		      type: Object,
              notify: true
		   },
          parsedData:{
		      type: Object,
              notify: true
		   }
        },
		handleSelectionChange: function (event) {
		   if(this.quaterMap[this.partnerType[this.selectedPartner]][this.yearsList[this.selectedYear]]){
		       this.quaterList=this.quaterMap[this.partnerType[this.selectedPartner]][this.yearsList[this.selectedYear]];
		   }else{
			 this.quaterList=[];
		   }
		   if(this.quaterList[this.selectedQuarter]){
				this.CreateChart();
		   }
        },
		CreateChart: function (event) {
		     var dealsResult={};
		     if(this.parsedData[this.partnerType[this.selectedPartner]]){
				if(this.parsedData[this.partnerType[this.selectedPartner]][this.yearsList[this.selectedYear]]){
					if(this.parsedData[this.partnerType[this.selectedPartner]][this.yearsList[this.selectedYear]][this.quaterList[this.selectedQuarter]]){
					   dealsResult=this.parsedData[this.partnerType[this.selectedPartner]][this.yearsList[this.selectedYear]][this.quaterList[this.selectedQuarter]];
					}
				}
			 }else{
				var filteredResult = this.masterAjaxData.filter(function(obj){
					if(obj.timePeriod.year == this.yearsList[this.selectedYear] && obj.timePeriod.quarter == this.quaterList[this.selectedQuarter] && obj.partnerType == this.partnerType[this.selectedPartner]  ){
					 return obj
				   }
				}.bind(this));
				
				
				filteredResult.map(function(obj){
				   for(var key in obj.count.deals){
					  if(dealsResult[key]){
						  dealsResult[key]+=obj.count.deals[key];
					  }else{
						  dealsResult[key]=obj.count.deals[key];
					  }
				   }
				}.bind(this));
				
				if(!this.parsedData[this.partnerType[this.selectedPartner]]){
				  this.parsedData[this.partnerType[this.selectedPartner]]={};
				}
				
				if(!this.parsedData[this.partnerType[this.selectedPartner]][this.yearsList[this.selectedYear]]){
				  this.parsedData[this.partnerType[this.selectedPartner]][this.yearsList[this.selectedYear]]={};
				}
				
				if(!this.parsedData[this.partnerType[this.selectedPartner]][this.yearsList[this.selectedYear]][this.quaterList[this.selectedQuarter]]){
				  this.parsedData[this.partnerType[this.selectedPartner]][this.yearsList[this.selectedYear]][this.quaterList[this.selectedQuarter]] = dealsResult;
				}
			 }
			 
			 var newdealsResult=[];
			 for(var key in dealsResult){
			    newdealsResult.push([key,dealsResult[key]]);
			 }
			 
			 if(newdealsResult.length > 0){
				this.chartrows=newdealsResult;
				this.showChart=true;
			 }else{
			    this.showChart=false;
				this.chartrows=[];
			 }
			 
        },
        dataLoaded: function (event,request) {
		    this.parsedData={};
		    this.masterAjaxData=request.response.result;
		    this.yearsList=request.response.result.map(function(obj){
			     return obj.timePeriod.year;
		    });
			
			this.yearsList=this.yearsList.filter(function(elem, pos) {
			  return this.yearsList.indexOf(elem) == pos;
			}.bind(this)).sort();
			
			 this.partnerType=request.response.result.map(function(obj){
			     return obj.partnerType;
		    });
			
			this.partnerType=this.partnerType.filter(function(elem, pos) {
			  return this.partnerType.indexOf(elem) == pos;
			}.bind(this)).sort();
			
			this.quaterMap={}
			for(var i=0;i<this.partnerType.length;i++){
				this.quaterMap[this.partnerType[i]]={};
				for(var k=0;k<this.yearsList.length;k++){
				    this.quaterMap[this.partnerType[i]][this.yearsList[k]]=request.response.result.filter(function(obj){
																				   return obj.partnerType===this.partnerType[i] && obj.timePeriod.year===this.yearsList[i]
																			}.bind(this));
					this.quaterMap[this.partnerType[i]][this.yearsList[k]]=this.quaterMap[this.partnerType[i]][this.yearsList[k]].map(function(obj){return obj.timePeriod.quarter}.bind(this));
					this.quaterMap[this.partnerType[i]][this.yearsList[k]]=this.quaterMap[this.partnerType[i]][this.yearsList[k]].filter(function(elem, pos) {
																						  return this.quaterMap[this.partnerType[i]][this.yearsList[k]].indexOf(elem) == pos;
																						}.bind(this)).sort();
				}
			}
        },
        errorHandler: function (event,detl) {
            alert("Error :"+ detl.error);
            
          }
      });
    })();
  </script>

</dom-module>